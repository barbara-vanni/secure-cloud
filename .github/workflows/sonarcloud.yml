name: SonarCloud Analysis
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcovr lcov cmake build-essential

      - name: Download and prepare SonarQube Build Wrapper
        run: |
          wget https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
          unzip build-wrapper-linux-x86.zip
          chmod +x build-wrapper-linux-x86/build-wrapper-linux-x86-64
          sudo mkdir -p /opt/build-wrapper
          sudo cp build-wrapper-linux-x86/build-wrapper-linux-x86-64 /opt/build-wrapper/
          sudo cp build-wrapper-linux-x86/libinterceptor-x86_64.so /opt/build-wrapper/
          sudo cp build-wrapper-linux-x86/libinterceptor-i686.so /opt/build-wrapper/
          echo "/opt/build-wrapper" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/opt/build-wrapper" >> $GITHUB_ENV


      - name: Build with Build Wrapper
        run: |
          # Auth-service
          cd auth-service
          rm -rf build
          mkdir -p build && cd build
          build-wrapper --out-dir ../../bw-output cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" ..
          make
          cd ../..
          # Files-service
          cd files-service
          rm -rf build
          mkdir -p build && cd build
          build-wrapper --out-dir ../../bw-output cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" ..
          make
          cd ../..
          # Audit-service
          cd audit-service
          rm -rf build
          mkdir -p build && cd build
          build-wrapper --out-dir ../../bw-output cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" ..
          make
          cd ../..
          # Messaging-service
          cd messaging-service
          rm -rf build
          mkdir -p build && cd build
          build-wrapper --out-dir ../../bw-output cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" ..
          make
          cd ../..


      - name: Generate coverage report
        run: |
          gcovr -r . --xml -o coverage.xml

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v2
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=barbara-vanni
            -Dsonar.projectKey=barbara-vanni_secure-cloud
            -Dsonar.projectVersion=${{ github.run_number }}
            -Dsonar.cfamily.build-wrapper-output=bw-output
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
